<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reus Party Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #fff; --muted: #888; }
        .light { --bg: #f5f5f5; --card: #fff; --text: #111; --muted: #666; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.5em; }
        .theme-toggle { background: var(--card); border: none; color: var(--text); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .top-section { margin-bottom: 20px; }
        .video-container { text-align: center; }
        .video-container img { max-width: 100%; border-radius: 8px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-stats { display: flex; gap: 20px; align-items: center; }
        .header-stat { font-size: 1.5em; font-weight: bold; }
        .header-stat.party { color: #ff6b6b; }
        .header-stat.people { color: #2ecc71; }
        .header-stat.cars { color: #3498db; }
        .header-stat.police { color: #e74c3c; }
        .header-stat .label { font-size: 0.5em; color: var(--muted); font-weight: normal; }
        .police-alert { background: #c0392b !important; }
        .police-alert header { background: #c0392b; }
        .last-updated { color: var(--muted); text-align: center; font-size: 0.9em; margin-bottom: 20px; }
        .error { color: #ff6b6b; text-align: center; padding: 10px; }
        .people-charts { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        .people-charts .chart-box { flex: 1; background: var(--card); border-radius: 8px; padding: 15px; }
        .chart-label { font-size: 0.8em; color: var(--muted); margin-bottom: 5px; display: flex; justify-content: flex-end; align-items: center; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .chart-header .legend-item { display: inline-flex; align-items: center; margin-right: 12px; cursor: pointer; font-size: 0.85em; }
        .chart-header .legend-item.hidden { opacity: 0.4; }
        .chart-header .legend-line { width: 20px; height: 2px; margin-right: 5px; }
        .time-btns button { padding: 2px 8px; margin-left: 4px; border: 1px solid var(--muted); background: var(--bg); color: var(--fg); border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .time-btns button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .plaza-row { display: flex; gap: 20px; margin-bottom: 20px; background: var(--card); border-radius: 8px; padding: 15px; }
        .plaza-info { flex: 0 0 20%; }
        .plaza-charts { flex: 0 0 78%; display: flex; flex-direction: column; gap: 10px; }
        .plaza-charts .chart-box { flex: 1; background: var(--bg); border-radius: 6px; padding: 10px; }
        .plaza h3 { margin-bottom: 10px; font-size: 1em; color: var(--muted); }
        .restaurant { padding: 6px 0; border-bottom: 1px solid var(--bg); display: flex; justify-content: space-between; }
        .restaurant:last-child { border-bottom: none; }
        .restaurant.included { color: #2ecc71; }
        .restaurant.closed { color: #ff6b6b; }
        .restaurant.excluded { color: var(--muted); }
        .busyness { font-size: 0.9em; }
        .top-rest-section { margin-top: 40px; }
        .top-rest-section h2 { color: var(--muted); margin-bottom: 20px; font-size: 1.2em; }
        .top-rest-row { background: var(--card); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .top-rest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .top-rest-name { font-weight: bold; }
        .top-rest-name.included { color: #2ecc71; }
        .top-rest-name.closed { color: #ff6b6b; }
        .top-rest-name.excluded { color: var(--muted); }
        .top-rest-meta { color: var(--muted); font-size: 0.85em; }
        .top-rest-charts { display: flex; gap: 10px; }
        .top-rest-charts .chart-box { flex: 1; background: var(--bg); border-radius: 6px; padding: 10px; }
        .map-section { margin: 30px 0; }
        .map-section h2 { color: var(--muted); margin-bottom: 15px; font-size: 1.2em; }
        #map { height: 400px; border-radius: 8px; }
        .data-timestamp { text-align: center; color: var(--muted); font-size: 0.8em; margin-top: 10px; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <header>
            <h1>üéâ Reus Party Tracker</h1>
            <div class="header-stats">
                <div class="header-stat party"><span id="party-level">-</span>/10 <span class="label">Party</span></div>
                <div class="header-stat people">~<span id="people-count">-</span> <span class="label">People</span></div>
                <div class="header-stat cars"><span id="car-count">-</span> <span class="label">Cars</span></div>
                <div class="header-stat police"><span id="police-count">-</span> (<span id="police-score">-</span>) <span class="label">Police</span></div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </header>
        
        <div class="top-section">
            <div class="video-container">
                <img id="screenshot" src="/api/screenshot" alt="Pla√ßa Mercadal">
            </div>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="people-charts">
            <div class="chart-box" style="grid-column: span 2;">
                <div class="chart-header">
                    <span id="chart-legend"></span>
                    <span class="time-btns">
                        <button onclick="loadPeopleChart(24)" id="ppl-24h">24h</button>
                        <button onclick="loadPeopleChart(168)" id="ppl-7d">7d</button>
                        <button onclick="loadPeopleChart(720)" id="ppl-30d">30d</button>
                        <button onclick="loadPeopleChart(8760)" id="ppl-1y">1y</button>
                    </span>
                </div>
                <canvas id="party-chart" height="80"></canvas>
            </div>
        </div>
        
        <div id="plazas"></div>
        
        <div class="map-section">
            <h2>üó∫Ô∏è Restaurant Heatmap</h2>
            <div id="map"></div>
        </div>
        
        <div class="top-rest-section">
            <h2>üèÜ Top 5 Restaurants in Reus</h2>
            <div id="top-restaurants"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const plazaOrder = ['placa_del_teatre', 'placa_mercadal', 'placa_evarist_fabregas'];
        const plazaColors = {'placa_mercadal': '#2ecc71', 'placa_evarist_fabregas': '#ffe66d', 'placa_del_teatre': '#95e1d3'};
        const charts = {};
        const chartOpts = {responsive: true, plugins: {legend: {display: false}, tooltip: {enabled: true}}, scales: {y: {beginAtZero: true, max: 100}}, interaction: {intersect: false, mode: 'index'}};
        
        function toggleTheme() {
            document.body.classList.toggle('light');
            document.querySelector('.theme-toggle').textContent = document.body.classList.contains('light') ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'light') toggleTheme();

        function makeChart(id, labels, values, color) {
            if (charts[id]) charts[id].destroy();
            const el = document.getElementById(id);
            if (!el) return;
            charts[id] = new Chart(el, {
                type: 'line',
                data: {labels, datasets: [{data: values, borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.3, pointRadius: 1}]},
                options: chartOpts
            });
        }
        function makeMultiChart(id, labels, datasets) {
            if (charts[id]) charts[id].destroy();
            const el = document.getElementById(id);
            if (!el) return;
            charts[id] = new Chart(el, {
                type: 'line',
                data: {labels, datasets: datasets.map(d => ({label: d.label, data: d.values, borderColor: d.color, backgroundColor: 'transparent', fill: false, tension: 0.3, pointRadius: 1, hidden: d.hidden || false}))},
                options: {...chartOpts, plugins: {legend: {display: false}}}
            });
            // Custom legend
            const legendEl = document.getElementById('chart-legend');
            if (legendEl) {
                legendEl.innerHTML = datasets.map((d, i) => 
                    `<span class="legend-item${d.hidden ? ' hidden' : ''}" data-idx="${i}"><span class="legend-line" style="background:${d.color}"></span>${d.label}</span>`
                ).join('');
                legendEl.querySelectorAll('.legend-item').forEach(item => {
                    item.onclick = () => {
                        const idx = +item.dataset.idx;
                        const ds = charts[id].data.datasets[idx];
                        ds.hidden = !ds.hidden;
                        item.classList.toggle('hidden');
                        charts[id].update();
                    };
                });
            }
        }

        async function fetchData() {
            try {
                const data = await (await fetch('/api/party')).json();
                document.getElementById('party-level').textContent = data.party_level;
                document.getElementById('people-count').textContent = data.people_count;
                document.getElementById('car-count').textContent = data.car_count || 0;
                document.getElementById('police-count').textContent = data.police_count || 0;
                document.getElementById('police-score').textContent = data.police_score || 0;
                document.getElementById('error').textContent = data.error || '';
                if ((data.police_score || 0) > 0) {
                    document.body.classList.add('police-alert');
                } else {
                    document.body.classList.remove('police-alert');
                }
            } catch (e) { document.getElementById('error').textContent = 'Failed to load data'; }
        }

        async function fetchRestaurants() {
            try {
                const resp = await (await fetch('/api/restaurants')).json();
                const data = resp.data || resp;
                const ts = resp.last_updated ? new Date(resp.last_updated * 1000).toLocaleTimeString() : '';
                let html = '';
                for (const plaza of plazaOrder) {
                    const restaurants = data[plaza] || [];
                    // Hide plaza if no restaurant has busyness > 0
                    if (!restaurants.some(r => r.busyness > 0)) continue;
                    const name = plaza.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    html += `<div class="plaza-row">
                        <div class="plaza-info"><div class="plaza"><h3>üìç ${name}</h3>`;
                    for (const r of restaurants) {
                        let cls, busy;
                        const q = r.hours_known === false ? '?' : '';
                        if (!r.is_open) {
                            cls = 'closed'; busy = 'Closed' + q;
                        } else if (r.busyness !== null) {
                            cls = 'included'; busy = r.busyness + '%';
                        } else {
                            cls = 'excluded'; busy = 'Open' + q;
                        }
                        html += `<div class="restaurant ${cls}"><span>${r.name}</span><span class="busyness">${busy}</span></div>`;
                    }
                    html += `</div></div>
                        <div class="plaza-charts">
                            <div class="chart-box"><div class="chart-label">24h</div><canvas id="${plaza}-daily" height="60"></canvas></div>
                            <div class="chart-box"><div class="chart-label">7d</div><canvas id="${plaza}-weekly" height="60"></canvas></div>
                        </div></div>`;
                }
                if (ts) html += `<div class="data-timestamp">Restaurant data updated: ${ts}</div>`;
                document.getElementById('plazas').innerHTML = html;
            } catch (e) {}
        }

        function getTimeFmt(hours) {
            return hours <= 24 ? d => new Date(d).toLocaleTimeString('en', {hour: '2-digit'}) 
                 : hours <= 168 ? d => new Date(d).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})
                 : d => new Date(d).toLocaleDateString('en', {month: 'short', day: 'numeric'});
        }
        function setActiveBtn(prefix, hours) {
            document.querySelectorAll(`#${prefix}-24h,#${prefix}-7d,#${prefix}-30d,#${prefix}-1y`).forEach(b => b.classList.remove('active'));
            document.getElementById(`${prefix}-${hours === 24 ? '24h' : hours === 168 ? '7d' : hours === 720 ? '30d' : '1y'}`).classList.add('active');
        }

        async function loadPeopleChart(hours) {
            setActiveBtn('ppl', hours);
            const data = await fetch(`/api/history?hours=${hours}`).then(r => r.json());
            const fmt = getTimeFmt(hours);
            makeMultiChart('party-chart', data.map(d => fmt(d.timestamp)), [
                {label: 'Total', values: data.map(d => d.people_count), color: '#2ecc71'},
                {label: 'Street', values: data.map(d => d.street_count || 0), color: '#3498db', hidden: true},
                {label: 'Terrace', values: data.map(d => d.terrace_count || 0), color: '#f1c40f', hidden: true},
                {label: 'Cars', values: data.map(d => d.car_count || 0), color: '#9b59b6'},
                {label: 'Police', values: data.map(d => d.police_score || 0), color: '#e74c3c'}
            ]);
        }

        async function fetchHistory() {
            try {
                const [restDaily, restWeekly] = await Promise.all([
                    fetch('/api/history/restaurants?hours=24').then(r => r.json()),
                    fetch('/api/history/restaurants?hours=168').then(r => r.json())
                ]);
                loadPeopleChart(24);
                for (const plaza of plazaOrder) {
                    const d = restDaily[plaza] || [], w = restWeekly[plaza] || [], color = plazaColors[plaza];
                    if (!d.some(x => x.busyness > 0) && !w.some(x => x.busyness > 0)) continue;
                    makeChart(`${plaza}-daily`, d.map(x => new Date(x.timestamp).toLocaleTimeString('en', {hour: '2-digit'})), d.map(x => x.busyness), color);
                    makeChart(`${plaza}-weekly`, w.map(x => new Date(x.timestamp).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})), w.map(x => x.busyness), color);
                }
            } catch (e) { console.error(e); }
        }

        async function fetchTopRestaurants() {
            try {
                const [resp, history] = await Promise.all([
                    fetch('/api/top-restaurants').then(r => r.json()),
                    fetch('/api/history/top-restaurants?hours=168').then(r => r.json())
                ]);
                const data = resp.data || resp;
                const ts = resp.last_updated ? new Date(resp.last_updated * 1000).toLocaleTimeString() : '';
                // Filter: only show restaurants that have history data
                const filtered = data.filter(r => history[r.name] && history[r.name].length > 0);
                const noData = data.filter(r => !history[r.name] || history[r.name].length === 0);
                let html = '';
                for (let i = 0; i < filtered.length; i++) {
                    const r = filtered[i];
                    const id = 'top-' + i;
                    let status, cls;
                    const q = r.hours_known === false ? '?' : '';
                    if (!r.is_open) { status = 'Closed' + q; cls = 'closed'; }
                    else if (r.busyness !== null) { status = r.busyness + '%'; cls = 'included'; }
                    else { status = 'Open' + q; cls = 'excluded'; }
                    html += `<div class="top-rest-row">
                        <div class="top-rest-header">
                            <span class="top-rest-name ${cls}">${i+1}. ${r.name}</span>
                            <span class="top-rest-meta">${r.reviews || 0} reviews ¬∑ ${r.rating || '-'}‚òÖ ¬∑ <span class="${cls}">${status}</span></span>
                        </div>
                        <div class="top-rest-charts">
                            <div class="chart-box"><div class="chart-label">24h</div><canvas id="${id}-daily" height="50"></canvas></div>
                            <div class="chart-box"><div class="chart-label">7d</div><canvas id="${id}-weekly" height="50"></canvas></div>
                        </div>
                    </div>`;
                }
                if (noData.length > 0) {
                    html += `<div style="color:var(--muted);margin-top:20px;font-size:0.9em;">No data yet: ${noData.map(r => r.name).join(', ')}</div>`;
                }
                if (ts) html += `<div class="data-timestamp">Top restaurants updated: ${ts}</div>`;
                document.getElementById('top-restaurants').innerHTML = html;
                return filtered;
            } catch (e) { console.error(e); return []; }
        }

        async function fetchTopHistory(restaurants) {
            try {
                const [daily, weekly] = await Promise.all([
                    fetch('/api/history/top-restaurants?hours=24').then(r => r.json()),
                    fetch('/api/history/top-restaurants?hours=168').then(r => r.json())
                ]);
                const colors = ['#ff6b6b','#2ecc71','#ffe66d','#95e1d3','#ff9f43','#a29bfe','#fd79a8','#00cec9','#e17055','#74b9ff',
                               '#ffeaa7','#dfe6e9','#b2bec3','#636e72','#2d3436','#fab1a0','#81ecec','#55efc4','#fdcb6e','#e84393'];
                for (let i = 0; i < restaurants.length; i++) {
                    const name = restaurants[i].name;
                    const d = daily[name] || [], w = weekly[name] || [];
                    const color = colors[i % colors.length];
                    makeChart(`top-${i}-daily`, d.map(x => new Date(x.timestamp).toLocaleTimeString('en', {hour: '2-digit'})), d.map(x => x.busyness), color);
                    makeChart(`top-${i}-weekly`, w.map(x => new Date(x.timestamp).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})), w.map(x => x.busyness), color);
                }
            } catch (e) { console.error(e); }
        }

        fetchData();
        fetchRestaurants().then(fetchHistory);
        fetchTopRestaurants().then(fetchTopHistory);
        setInterval(fetchData, 60000);
        setInterval(() => fetchRestaurants().then(fetchHistory), 900000);
        setInterval(() => fetchTopRestaurants().then(fetchTopHistory), 900000);
        setInterval(() => { document.getElementById('screenshot').src = '/api/screenshot?' + Date.now(); }, 30000);

        // Map
        const COORDS = {"Casa Coder":[41.1551769,1.1091342],"Roslena Mercadal":[41.1553117,1.1086407],"Goofretti Reus":[41.1548071,1.1089552],"El Mestral":[41.1550088,1.108353],"Maiki Pok√©":[41.15481,1.10886],"DITALY":[41.1549682,1.1090279],"D√©u n'hi Do!":[41.155236,1.1090733],"La Pres√≥":[41.155306,1.109933],"Sibuya Urban Sushi Bar":[41.1554246,1.1102739],"Yokoso":[41.1551878,1.109917],"Saona Reus":[41.1551485,1.1103246],"Oplontina PizzaBar":[41.1541791,1.1083387],"As De Copes Gastropub":[41.154012,1.108272],"Restaurant del Museu del Vermut":[41.1560537,1.1099607],"Tacos La Mexicanita Reus":[41.1538978,1.1124276],"Vermuts Rofes":[41.1577865,1.107371],"Khirganga Restaurant":[41.1516227,1.0976766],"Xivarri Gastronom√≠a SLU":[41.1548652,1.1074598],"Ciutat Gaud√≠":[41.1538713,1.1021827],"Cerveseria Tower Reus":[41.1448412,1.1147073],"Bar Bon-Mar":[41.1545849,1.1072201],"Il Cuore":[41.1551298,1.1099764],"Little Bangkok":[41.1560105,1.1098194],"Braser√≠a COSTILLAR DE REUS":[41.1529128,1.1065],"Mirall de Tres cuina d'Autor":[41.1548,1.1078],"Xapatti":[41.1545,1.1085],"Ferran Cerro Restaurant":[41.1542,1.1072],"Vill Rus Restaurant":[41.1555,1.1095],"Restaurant Cal Marc":[41.1538,1.1088],"Acarigua Arepera":[41.1547,1.1082],"Restaurant Lo Bon Profit":[41.1543,1.1076],"Restaurant La Comarca":[41.1535,1.1068],"Tapes i Tapes":[41.1549,1.1079],"Flaps":[41.1541,1.1091],"V√çTRIC Taverna Gastron√≤mica":[41.1546,1.1087]};
        let map, markers = [];
        
        async function updateMapMarkers() {
            if (!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            try {
                const [plazasResp, topResp] = await Promise.all([
                    fetch('/api/restaurants').then(r => r.json()),
                    fetch('/api/top-restaurants').then(r => r.json())
                ]);
                const plazas = plazasResp.data || plazasResp;
                const top = topResp.data || topResp;
                const all = [...Object.values(plazas).flat(), ...top];
                for (const rest of all) {
                    const coord = COORDS[rest.name];
                    // Only show on map if open AND has busyness data
                    if (!coord || !rest.is_open || rest.busyness === null) continue;
                    const t = Math.min(rest.busyness / 100, 1);
                    const color = `rgb(${Math.round(255*t)},50,${Math.round(255*(1-t))})`;
                    const marker = L.circleMarker([coord[0], coord[1]], {
                        radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8
                    }).addTo(map).bindPopup(`<b>${rest.name}</b><br>${rest.busyness}% busy`);
                    markers.push(marker);
                }
            } catch (e) { console.error(e); }
        }
        
        // Init map
        map = L.map('map').setView([41.1548, 1.1085], 15);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        updateMapMarkers();
        setInterval(updateMapMarkers, 900000);
    </script>
</body>
</html>
