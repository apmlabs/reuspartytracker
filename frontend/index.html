<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reus Party Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #fff; --muted: #888; }
        .light { --bg: #f5f5f5; --card: #fff; --text: #111; --muted: #666; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.5em; }
        .theme-toggle { background: var(--card); border: none; color: var(--text); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .top-section { margin-bottom: 20px; }
        .video-container { text-align: center; }
        .video-container img { max-width: 100%; border-radius: 8px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-stats { display: flex; gap: 20px; align-items: center; }
        .header-stat { font-size: 1.5em; font-weight: bold; }
        .header-stat.party { color: #ff6b6b; }
        .header-stat.people { color: #4ecdc4; }
        .header-stat .label { font-size: 0.5em; color: var(--muted); font-weight: normal; }
        .last-updated { color: var(--muted); text-align: center; font-size: 0.9em; margin-bottom: 20px; }
        .error { color: #ff6b6b; text-align: center; padding: 10px; }
        .people-charts { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        .people-charts .chart-box { flex: 1; background: var(--card); border-radius: 8px; padding: 15px; }
        .chart-label { font-size: 0.8em; color: var(--muted); margin-bottom: 5px; }
        .plaza-row { display: flex; gap: 20px; margin-bottom: 20px; background: var(--card); border-radius: 8px; padding: 15px; }
        .plaza-info { flex: 0 0 20%; }
        .plaza-charts { flex: 0 0 78%; display: flex; flex-direction: column; gap: 10px; }
        .plaza-charts .chart-box { flex: 1; background: var(--bg); border-radius: 6px; padding: 10px; }
        .plaza h3 { margin-bottom: 10px; font-size: 1em; color: var(--muted); }
        .restaurant { padding: 6px 0; border-bottom: 1px solid var(--bg); display: flex; justify-content: space-between; }
        .restaurant:last-child { border-bottom: none; }
        .restaurant.included { color: #4ecdc4; }
        .restaurant.closed { color: #ff6b6b; }
        .restaurant.excluded { color: var(--muted); }
        .busyness { font-size: 0.9em; }
        .top-rest-section { margin-top: 40px; }
        .top-rest-section h2 { color: var(--muted); margin-bottom: 20px; font-size: 1.2em; }
        .top-rest-row { background: var(--card); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .top-rest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .top-rest-name { font-weight: bold; }
        .top-rest-meta { color: var(--muted); font-size: 0.85em; }
        .top-rest-charts { display: flex; gap: 10px; }
        .top-rest-charts .chart-box { flex: 1; background: var(--bg); border-radius: 6px; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéâ Reus Party Tracker</h1>
            <div class="header-stats">
                <div class="header-stat party"><span id="party-level">-</span>/10 <span class="label">Party</span></div>
                <div class="header-stat people">~<span id="people-count">-</span> <span class="label">People</span></div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </header>
        
        <div class="top-section">
            <div class="video-container">
                <img id="screenshot" src="/api/screenshot" alt="Pla√ßa Mercadal">
            </div>
        </div>
        
        <div class="last-updated" id="last-updated">Loading...</div>
        <div class="error" id="error"></div>
        
        <div class="people-charts">
            <div class="chart-box">
                <div class="chart-label">People - Last 24 Hours</div>
                <canvas id="party-daily" height="80"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-label">People - Last 7 Days</div>
                <canvas id="party-weekly" height="80"></canvas>
            </div>
        </div>
        
        <div id="plazas"></div>
        
        <div class="top-rest-section">
            <h2>üèÜ Top 20 Restaurants in Reus</h2>
            <div id="top-restaurants"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const plazaOrder = ['placa_del_teatre', 'placa_mercadal', 'placa_evarist_fabregas'];
        const plazaColors = {'placa_mercadal': '#4ecdc4', 'placa_evarist_fabregas': '#ffe66d', 'placa_del_teatre': '#95e1d3'};
        const charts = {};
        const chartOpts = {responsive: true, plugins: {legend: {display: false}}, scales: {y: {beginAtZero: true, max: 100}}};
        
        function toggleTheme() {
            document.body.classList.toggle('light');
            document.querySelector('.theme-toggle').textContent = document.body.classList.contains('light') ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'light') toggleTheme();

        function makeChart(id, labels, values, color) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {labels, datasets: [{data: values, borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.3, pointRadius: 1}]},
                options: chartOpts
            });
        }

        async function fetchData() {
            try {
                const data = await (await fetch('/api/party')).json();
                document.getElementById('party-level').textContent = data.party_level;
                document.getElementById('people-count').textContent = data.people_count;
                document.getElementById('error').textContent = data.error || '';
                if (data.last_updated) {
                    const ago = Math.round((Date.now() - new Date(data.last_updated)) / 60000);
                    document.getElementById('last-updated').textContent = `Updated ${ago} min ago`;
                }
            } catch (e) { document.getElementById('error').textContent = 'Failed to load data'; }
        }

        async function fetchRestaurants() {
            try {
                const data = await (await fetch('/api/restaurants')).json();
                let html = '';
                for (const plaza of plazaOrder) {
                    const restaurants = data[plaza] || [];
                    const name = plaza.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    html += `<div class="plaza-row">
                        <div class="plaza-info"><div class="plaza"><h3>üìç ${name}</h3>`;
                    for (const r of restaurants) {
                        let cls, busy;
                        if (!r.is_open) {
                            cls = 'closed'; busy = 'Closed';
                        } else if (r.busyness !== null) {
                            cls = 'included'; busy = r.busyness + '%';
                        } else {
                            cls = 'excluded'; busy = 'Open';
                        }
                        html += `<div class="restaurant ${cls}"><span>${r.name}</span><span class="busyness">${busy}</span></div>`;
                    }
                    html += `</div></div>
                        <div class="plaza-charts">
                            <div class="chart-box"><div class="chart-label">24h</div><canvas id="${plaza}-daily" height="60"></canvas></div>
                            <div class="chart-box"><div class="chart-label">7d</div><canvas id="${plaza}-weekly" height="60"></canvas></div>
                        </div></div>`;
                }
                document.getElementById('plazas').innerHTML = html;
            } catch (e) {}
        }

        async function fetchHistory() {
            try {
                const [daily, weekly, restDaily, restWeekly] = await Promise.all([
                    fetch('/api/history?hours=24').then(r => r.json()),
                    fetch('/api/history?hours=168').then(r => r.json()),
                    fetch('/api/history/restaurants?hours=24').then(r => r.json()),
                    fetch('/api/history/restaurants?hours=168').then(r => r.json())
                ]);
                makeChart('party-daily', daily.map(d => new Date(d.timestamp).toLocaleTimeString('en', {hour: '2-digit'})), daily.map(d => d.people_count), '#ff6b6b');
                makeChart('party-weekly', weekly.map(d => new Date(d.timestamp).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})), weekly.map(d => d.people_count), '#ff6b6b');
                for (const plaza of plazaOrder) {
                    const d = restDaily[plaza] || [], w = restWeekly[plaza] || [], color = plazaColors[plaza];
                    makeChart(`${plaza}-daily`, d.map(x => new Date(x.timestamp).toLocaleTimeString('en', {hour: '2-digit'})), d.map(x => x.busyness), color);
                    makeChart(`${plaza}-weekly`, w.map(x => new Date(x.timestamp).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})), w.map(x => x.busyness), color);
                }
            } catch (e) { console.error(e); }
        }

        async function fetchTopRestaurants() {
            try {
                const data = await (await fetch('/api/top-restaurants')).json();
                let html = '';
                for (let i = 0; i < data.length; i++) {
                    const r = data[i];
                    const id = 'top-' + i;
                    let status, cls;
                    if (!r.is_open) { status = 'Closed'; cls = 'closed'; }
                    else if (r.busyness !== null) { status = r.busyness + '%'; cls = 'included'; }
                    else { status = 'Open'; cls = 'excluded'; }
                    html += `<div class="top-rest-row">
                        <div class="top-rest-header">
                            <span class="top-rest-name ${cls}">${i+1}. ${r.name}</span>
                            <span class="top-rest-meta">${r.reviews || 0} reviews ¬∑ ${r.rating || '-'}‚òÖ ¬∑ <span class="${cls}">${status}</span></span>
                        </div>
                        <div class="top-rest-charts">
                            <div class="chart-box"><div class="chart-label">24h</div><canvas id="${id}-daily" height="50"></canvas></div>
                            <div class="chart-box"><div class="chart-label">7d</div><canvas id="${id}-weekly" height="50"></canvas></div>
                        </div>
                    </div>`;
                }
                document.getElementById('top-restaurants').innerHTML = html;
                return data;
            } catch (e) { console.error(e); return []; }
        }

        async function fetchTopHistory(restaurants) {
            try {
                const [daily, weekly] = await Promise.all([
                    fetch('/api/history/top-restaurants?hours=24').then(r => r.json()),
                    fetch('/api/history/top-restaurants?hours=168').then(r => r.json())
                ]);
                const colors = ['#ff6b6b','#4ecdc4','#ffe66d','#95e1d3','#ff9f43','#a29bfe','#fd79a8','#00cec9','#e17055','#74b9ff',
                               '#ffeaa7','#dfe6e9','#b2bec3','#636e72','#2d3436','#fab1a0','#81ecec','#55efc4','#fdcb6e','#e84393'];
                for (let i = 0; i < restaurants.length; i++) {
                    const name = restaurants[i].name;
                    const d = daily[name] || [], w = weekly[name] || [];
                    const color = colors[i % colors.length];
                    makeChart(`top-${i}-daily`, d.map(x => new Date(x.timestamp).toLocaleTimeString('en', {hour: '2-digit'})), d.map(x => x.busyness), color);
                    makeChart(`top-${i}-weekly`, w.map(x => new Date(x.timestamp).toLocaleDateString('en', {weekday: 'short', hour: '2-digit'})), w.map(x => x.busyness), color);
                }
            } catch (e) { console.error(e); }
        }

        fetchData();
        fetchRestaurants().then(fetchHistory);
        fetchTopRestaurants().then(fetchTopHistory);
        setInterval(fetchData, 60000);
        setInterval(() => fetchRestaurants().then(fetchHistory), 900000);
        setInterval(() => fetchTopRestaurants().then(fetchTopHistory), 900000);
        setInterval(() => { document.getElementById('screenshot').src = '/api/screenshot?' + Date.now(); }, 30000);
    </script>
</body>
</html>
