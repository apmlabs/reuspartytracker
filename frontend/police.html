<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Sightings - Reus Party Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #fff; --muted: #888; --accent: #e74c3c; }
        .light { --bg: #f5f5f5; --card: #fff; --text: #111; --muted: #666; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.5em; }
        h1 a { color: var(--text); text-decoration: none; }
        .theme-toggle { background: var(--card); border: none; color: var(--text); padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .viewer { margin-bottom: 20px; }
        .screenshot-section { width: 100%; }
        .screenshot-container { position: relative; text-align: center; }
        .screenshot-container img { max-width: 100%; border-radius: 8px; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; border: none; padding: 15px 20px; cursor: pointer; font-size: 1.5em; border-radius: 4px; }
        .nav-btn:hover { background: rgba(0,0,0,0.9); }
        .nav-btn.prev { left: 10px; }
        .nav-btn.next { right: 10px; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .info-bar { display: flex; justify-content: center; gap: 30px; padding: 10px; color: var(--muted); align-items: center; flex-wrap: wrap; }
        .info-bar .item { display: flex; align-items: center; gap: 5px; }
        .info-bar .value { color: var(--text); font-weight: bold; }
        .info-bar .value.police { color: var(--accent); }
        .info-bar .value.people { color: #2ecc71; }
        .chart-section { background: var(--card); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .chart-section canvas { cursor: crosshair; }
        .list-section { background: var(--card); border-radius: 8px; padding: 15px; }
        .list-section h3 { margin-bottom: 10px; color: var(--muted); }
        .sighting-list { max-height: 300px; overflow-y: auto; }
        .sighting-item { padding: 8px; border-bottom: 1px solid var(--bg); cursor: pointer; display: flex; justify-content: space-between; }
        .sighting-item:hover { background: var(--bg); }
        .sighting-item.active { background: var(--accent); color: #fff; }
        .sighting-time { font-size: 0.9em; }
        .sighting-score { color: var(--accent); font-weight: bold; }
        .sighting-item.active .sighting-score { color: #fff; }
        .counter { text-align: center; color: var(--muted); margin-top: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="/">ðŸš” Police Sightings</a></h1>
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
        </header>

        <div class="viewer">
            <div class="screenshot-section">
                <div class="screenshot-container">
                    <button class="nav-btn prev" onclick="navigate(-1)">â—€</button>
                    <img id="screenshot" src="" alt="Screenshot">
                    <button class="nav-btn next" onclick="navigate(1)">â–¶</button>
                </div>
                <div class="info-bar">
                    <div class="item"><span id="current-idx">0</span> / <span id="total">0</span></div>
                    <div class="item">ðŸ“… <span class="value" id="timestamp">-</span></div>
                    <div class="item">ðŸš” Score: <span class="value police" id="police-score">-</span></div>
                    <div class="item" id="breakdown-container"></div>
                    <div class="item">ðŸ‘¥ <span class="value people" id="people-count">-</span></div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <canvas id="chart" height="100"></canvas>
        </div>

        <div class="list-section">
            <h3>All Sightings (<span id="list-count">0</span>)</h3>
            <div class="sighting-list" id="sighting-list"></div>
        </div>
    </div>

    <script>
        let sightings = [];
        let currentIdx = 0;
        let chart = null;

        async function loadData() {
            const res = await fetch('/api/police-sightings');
            sightings = (await res.json()).reverse();  // oldest first
            document.getElementById('total').textContent = sightings.length;
            document.getElementById('list-count').textContent = sightings.length;
            renderList();
            renderChart();
            if (sightings.length > 0) showSighting(sightings.length - 1);  // start at newest
            updateNavButtons();
        }

        function showSighting(idx) {
            if (idx < 0 || idx >= sightings.length) return;
            currentIdx = idx;
            const s = sightings[idx];
            const img = document.getElementById('screenshot');
            img.style.opacity = '0.3';
            img.onload = () => img.style.opacity = '1';
            img.src = s.screenshot ? `/api/screenshot/${s.screenshot}` : '';
            document.getElementById('current-idx').textContent = idx + 1;
            document.getElementById('timestamp').textContent = new Date(s.timestamp).toLocaleString();
            document.getElementById('police-score').textContent = s.police_score;
            document.getElementById('people-count').textContent = s.people_count;
            const parts = [];
            if (s.police_cars) parts.push(`${s.police_cars} car${s.police_cars > 1 ? 's' : ''}`);
            if (s.police_vans) parts.push(`${s.police_vans} van${s.police_vans > 1 ? 's' : ''}`);
            if (s.police_uniformed) parts.push(`${s.police_uniformed} officer${s.police_uniformed > 1 ? 's' : ''}`);
            document.getElementById('breakdown-container').innerHTML = parts.length ? `(${parts.join(', ')})` : '';
            document.querySelectorAll('.sighting-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.idx) === idx);
            });
            updateNavButtons();
        }

        function navigate(delta) {
            showSighting(currentIdx + delta);
        }

        function updateNavButtons() {
            document.querySelector('.nav-btn.prev').disabled = currentIdx <= 0;
            document.querySelector('.nav-btn.next').disabled = currentIdx >= sightings.length - 1;
        }

        function renderList() {
            const list = document.getElementById('sighting-list');
            list.innerHTML = sightings.map((s, i) => `
                <div class="sighting-item" data-idx="${i}" onclick="showSighting(${i})">
                    <span class="sighting-time">${new Date(s.timestamp).toLocaleString()}</span>
                    <span class="sighting-score">Score: ${s.police_score}</span>
                </div>
            `).reverse().join('');
        }

        function renderChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sightings.map(s => new Date(s.timestamp)),
                    datasets: [{
                        label: 'Police Score',
                        data: sightings.map(s => s.police_score),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'People',
                        data: sightings.map(s => s.people_count),
                        borderColor: '#2ecc71',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { intersect: false, mode: 'index' },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            showSighting(elements[0].index);
                        }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#888' }, grid: { color: '#333' } },
                        y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#333' } }
                    },
                    plugins: { legend: { labels: { color: '#888' } } }
                }
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = document.body.classList.contains('light') ? 'ðŸŒ™' : 'â˜€ï¸';
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
        });

        loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</body>
</html>
